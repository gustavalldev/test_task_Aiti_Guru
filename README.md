# Order API

REST-сервис на FastAPI для добавления товаров в заказ. При повторном добавлении товар обновляет количество, а не создаёт новую позицию. При отсутствии товара на складе возвращается ошибка.

## Быстрый старт (Docker)

```bash
docker compose up -d --build
```

Сервис будет доступен на `http://127.0.0.1:8000`. Чтобы остановить контейнеры, выполните `docker compose down`. Для полного сброса данных добавьте ключ `-v`.

> Для локального запуска без Docker остаётся возможность использовать виртуальное окружение и `uvicorn` вручную — см. предыдущие шаги при необходимости.

## Добавление товара в заказ

`POST /orders/{order_id}/items`

Тело запроса:

```json
{
  "product_id": 1,
  "quantity": 2
}
```

Варианты ответов:

- `201 Created` — позиция добавлена/обновлена. Возвращается JSON с информацией о позиции.
- `404 Not Found` — заказ или товар не найдены.
- `409 Conflict` — на складе не хватает товара.

## Структура БД

- `categories` — древовидный справочник категорий.
- `products` — номенклатура товаров со складским остатком (`quantity`).
- `clients` — заказчики с адресом доставки.
- `orders` — заголовки заказов, привязанные к клиенту.
- `order_items` — позиции заказа с составным PK `(order_id, product_id)` и ценой `price_at_order`.

## Тестирование

Базовые сценарии можно проверить через `pytest` (необязательно) либо выполнить curl-запрос:

```bash
curl -X POST http://127.0.0.1:8000/orders/1/items \
  -H "Content-Type: application/json" \
  -d '{"product_id": 1, "quantity": 2}'
```

## Запуск в Docker

```bash
docker compose up -d --build
```

- сервис доступен на `http://127.0.0.1:8000`;
- база `PostgreSQL` поднимается в контейнере `db`, создаёт БД `test_task_aiti_guru` и наполняется из `db1.sql` (для подключения с хоста используйте порт `5433`);
- переменная `DATABASE_URL` внутри контейнера указывает на `postgresql+psycopg2://postgres:postgres@db:5432/test_task_aiti_guru`. Измените её в `docker-compose.yml`, если используете другую БД.

Чтобы остановить сервисы, выполните `docker compose down`. Для полного сброса данных используйте `docker compose down -v` (при следующем запуске скрипт инициализации выполнится заново).
